---

- name: Prepare
  hosts: all
  become: yes
  vars:
    proxy_use: "{{ True if ( https_proxy is defined and https_proxy|length > 0 ) else False }}"
    https_proxy: "{{ lookup('env', 'HTTPS_PROXY') | default('') }}"
    http_proxy: "{{ lookup('env', 'HTTP_PROXY') | default('') }}"
    no_proxy: "{{ lookup('env', 'NO_PROXY') | default('127.0.0.1,localhost') }}"

    iptables_distros:
      - debian10
      - ubuntu1804
      - rhel7
      - centos7

    ufw_distros:
      - debian11
      - ubuntu2004
      - ubuntu2204
  
    firewalld_distros:
      - fedora35
      - fedora36
      - centos8
      - centos9
      - oraclelinux8
      - oraclelinux9
      - rockylinux8
      - rockylinux9
      - almalinux8
      - almalinux9

    molecule_distro: "{{ lookup('env', 'MOLECULE_DISTRO') }}"
<% for key, value in molecule['prepare']['vars'].items() %>
    <= key =>: <= value =>
<% endfor %>
  tasks:

    - block:

        - name: Configure APT to use proxy
          copy:
            content: |
              Acquire::http::proxy "{{ http_proxy }}/";
              Acquire::https::proxy "{{ https_proxy }}/";
              Acquire::gtp::proxy "{{ https_proxy }}/";
            dest: /etc/apt/apt.conf.d/80proxy
            owner: root
            group: root
            mode: "0644"
          when: proxy_use is defined and proxy_use|bool

        - name: Update APT cache
          apt:
            update_cache: yes
            cache_valid_time: 1

        - name: Install default packages
          package:
            name:
              - gnupg
              - ssh
            state: present

        - name: Update APT cache
          apt:
            update_cache: yes
            cache_valid_time: 1

      when: ansible_os_family == 'Debian'

    - block:

        - name: Configure YUM to use proxy
          lineinfile:
            path: /etc/yum.conf
            line: "proxy={{ https_proxy }}"
            regexp: "^proxy=.*$"
          when: proxy_use is defined and proxy_use|bool

        - name: Update YUM cache  # noqa command-instead-of-module
          command: yum makecache
          changed_when: false

      when: ansible_os_family == 'RedHat' and (ansible_distribution_major_version|int) < 8

    - block:

        - name: Configure DNF to use proxy
          lineinfile:
            path: /etc/dnf/dnf.conf
            line: "proxy={{ https_proxy }}"
            regexp: "^proxy=.*$"
          when: proxy_use is defined and proxy_use|bool

        - name: Update DNF cache
          dnf:
            update_cache: yes

      when: ansible_os_family == 'RedHat' and (ansible_distribution_major_version|int) >= 8


    - block:

        - name: Install iptables
          include_role:
            name: iptables
          when: molecule_distro in iptables_distros

        - name: Install ufw
          include_role:
            name: ufw
          when: molecule_distro in ufw_distros

        - name: Install firewalld
          include_role:
            name: firewalld
          when: molecule_distro in firewalld_distros

      when: prepare_firewall is defined and prepare_firewall|bool

    - block:

        - name: Register all nodes in /etc/hosts
          include_role:
            name: hosts

      when: register_hosts is defined and register_hosts|bool
